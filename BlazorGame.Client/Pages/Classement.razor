@page "/classement"
@using BlazorGame.Client.Services
@using SharedModels.DTOs
@inject GameService GameService

@* Page de classement des meilleurs joueurs *@

<PageTitle>Classement</PageTitle>

<div class="h-full bg-medieval-dark/50 py-8">
    <div class="container mx-auto px-4 max-w-4xl flex flex-col gap-8">
        <div class="card text-center p-8 transform hover:scale-[1.02] transition-transform duration-300">
            <div class="flex justify-center items-center gap-4 mb-2">
                <div class="h-1 flex-1 bg-medieval-accent/30"></div>
                <h1 class="text-4xl font-medieval">Classement des Aventuriers</h1>
                <div class="h-1 flex-1 bg-medieval-accent/30"></div>
            </div>
            <p class="text-medieval-light opacity-80 text-lg font-medieval">Les plus vaillants héros du royaume</p>
        </div>

        <div class="card overflow-hidden p-6 transform hover:scale-[1.01] transition-transform duration-300">
            @if (isLoading)
            {
                <div class="text-center py-8">
                    <p class="text-medieval-light font-medieval">Chargement du classement...</p>
                </div>
            }
            else if (leaderboard == null || !leaderboard.Any())
            {
                <div class="text-center py-8">
                    <p class="text-medieval-light font-medieval">Aucun aventurier n'a encore relevé le défi...</p>
                </div>
            }
            else
            {
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="border-b-2 border-medieval-accent">
                                <th class="px-6 py-4 text-center font-medieval text-lg text-medieval-accent">Rang</th>
                                <th class="px-6 py-4 text-center font-medieval text-lg text-medieval-accent">Héros</th>
                                <th class="px-6 py-4 text-center font-medieval text-lg text-medieval-accent">Score</th>
                                <th class="px-6 py-4 text-center font-medieval text-lg text-medieval-accent">Donjons</th>
                                <th class="px-6 py-4 text-center font-medieval text-lg text-medieval-accent">Dernière Quête</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-medieval-accent/30">
                            @foreach (var (entry, index) in leaderboard.Select((e, i) => (e, i)))
                            {
                                <tr class="hover:bg-medieval-secondary/30 transition-colors">
                                    <td class="px-6 py-4 text-center">
                                        <span class="font-medieval text-2xl text-medieval-accent">@(index + 1)</span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <div class="font-medieval text-lg">@GetUserDisplayName(entry.UserId)</div>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <div class="font-medieval text-xl text-medieval-accent">@entry.TotalScore</div>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <div class="font-medieval text-xl">@entry.TotalSessions</div>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <div class="text-medieval-light text-sm">@GetRelativeTime(entry.LastSessionDate)</div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<LeaderboardEntry>? leaderboard;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadLeaderboardAsync();
    }

    private async Task LoadLeaderboardAsync()
    {
        isLoading = true;
        leaderboard = await GameService.GetLeaderboardAsync();
        isLoading = false;
    }

    private string GetUserDisplayName(Guid userId)
    {
        var entry = leaderboard?.FirstOrDefault(e => e.UserId == userId);
        return entry?.Username ?? $"Aventurier {userId.ToString().Substring(0, 8)}";
    }

    private string GetRelativeTime(DateTime? date)
    {
        if (date == null)
            return "Jamais";

        var timeSpan = DateTime.UtcNow - date.Value;

        if (timeSpan.TotalMinutes < 1)
            return "À l'instant";
        if (timeSpan.TotalMinutes < 60)
            return $"Il y a {(int)timeSpan.TotalMinutes} minute{((int)timeSpan.TotalMinutes > 1 ? "s" : "")}";
        if (timeSpan.TotalHours < 24)
            return $"Il y a {(int)timeSpan.TotalHours} heure{((int)timeSpan.TotalHours > 1 ? "s" : "")}";
        if (timeSpan.TotalDays < 30)
            return $"Il y a {(int)timeSpan.TotalDays} jour{((int)timeSpan.TotalDays > 1 ? "s" : "")}";

        return date.Value.ToString("dd/MM/yyyy");
    }
}
